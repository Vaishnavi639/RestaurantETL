import pdfplumber
from pdf2image import convert_from_path
from pathlib import Path
import logging
from typing import Dict

logger = logging.getLogger(__name__)
logging.basicConfig(level=logging.INFO)

# lazy PaddleOCR instance (module-level)
_PADDLE_OCR = None

def get_paddle_ocr():
    global _PADDLE_OCR
    if _PADDLE_OCR is None:
        try:
            from paddleocr import PaddleOCR
        except Exception as e:
            logger.error("PaddleOCR not installed. Install paddleocr to run OCR fallback.")
            raise
        _PADDLE_OCR = PaddleOCR(use_angle_cls=True, lang='en', show_log=False)
        logger.info("Initialized shared PaddleOCR instance")
    return _PADDLE_OCR


class PDFExtractor:
    supported_formats = ['.pdf']

    def extract_text(self, pdf_path: str) -> Dict[str, any]:
        pdf_path = Path(pdf_path)
        if not pdf_path.exists():
            raise FileNotFoundError(f"PDF not found: {pdf_path}")
        if pdf_path.suffix.lower() not in self.supported_formats:
            raise ValueError("Not a PDF")

        logger.info(f"üìÑ Starting extraction from: {pdf_path.name}")

        # Try direct extraction
        text_blocks = []
        try:
            with pdfplumber.open(pdf_path) as pdf:
                logger.info(f"üìë PDF has {len(pdf.pages)} pages")
                for i, page in enumerate(pdf.pages, 1):
                    try:
                        txt = page.extract_text() or ""
                        if txt.strip():
                            text_blocks.append(f"--- Page {i} ---\n{txt.strip()}")
                            logger.info(f"‚úì Page {i}: {len(txt)} characters")
                        else:
                            logger.warning(f"‚ö†Ô∏è Page {i}: No text found")
                    except Exception as e:
                        logger.error(f"Error extracting text from page {i}: {e}")
        except Exception as e:
            logger.error(f"Direct PDF read failed: {e}")

        combined = "\n\n".join(text_blocks).strip()

        # If little or no text, fallback to OCR (image PDF)
        if len(combined) < 60:
            logger.info("‚ö†Ô∏è Low-text PDF detected; using OCR rasterization fallback")
            combined = self._ocr_pdf(pdf_path)

        return {
            'text': combined,
            'source_file': pdf_path.name,
            'extraction_method': 'text' if len(combined) > 60 else 'ocr',
            'char_count': len(combined),
            'success': len(combined) > 0
        }

    def _ocr_pdf(self, pdf_path: Path) -> str:
        try:
            images = convert_from_path(str(pdf_path), dpi=300)
        except Exception as e:
            logger.error(f"Failed to rasterize PDF: {e}")
            return ""

        ocr = get_paddle_ocr()
        pages_text = []
        for i, img in enumerate(images, 1):
            try:
                result = ocr.ocr(img, cls=True)
                if result and result[0]:
                    lines = []
                    for line in result[0]:
                        text = line[1][0]
                        conf = line[1][1]
                        if conf >= 0.5:
                            lines.append(text)
                    page_text = "\n".join(lines).strip()
                    if page_text:
                        pages_text.append(f"--- Page {i} ---\n{page_text}")
                        logger.info(f"‚úì OCR page {i}: {len(lines)} lines")
                    else:
                        logger.warning(f"‚ö†Ô∏è OCR page {i}: no confident lines")
                else:
                    logger.warning(f"‚ö†Ô∏è OCR page {i}: empty result")
            except Exception as e:
                logger.error(f"OCR error on page {i}: {e}")
        return "\n\n".join(pages_text)

